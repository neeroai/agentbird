# üö¶ Orchestrator Coordinator - Implementaci√≥n Completa

## üéØ Descripci√≥n del Agente

El **Orchestrator Coordinator** es el cerebro central del sistema multimodal UrbanHub, implementando patrones avanzados de **LangChain DialogueSimulator** para orquestaci√≥n inteligente de conversaciones entre agentes especializados.

### üß† Especializaci√≥n Core

```python
AGENT_SPECIALIZATIONS = {
    'intent_classification': {
        'description': 'Clasificaci√≥n multi-dimensional de intenciones',
        'confidence_threshold': 0.85,
        'supported_languages': ['es', 'en'],
        'max_processing_time': 800  # ms
    },
    'conversation_routing': {
        'description': 'Routing inteligente basado en capacidades de agentes',
        'routing_algorithms': ['bidding_system', 'load_balancing', 'affinity_matching'],
        'fallback_levels': 4
    },
    'context_management': {
        'description': 'Gesti√≥n de contexto cross-modal y temporal',
        'context_window': 10,  # interactions
        'context_types': ['conversational', 'property', 'user_profile', 'interaction_history']
    },
    'escalation_handling': {
        'description': 'Manejo inteligente de escalaciones autom√°ticas y manuales',
        'escalation_triggers': ['complexity_threshold', 'failure_rate', 'user_request', 'time_threshold'],
        'escalation_targets': ['human_agent', 'supervisor', 'specialist_team']
    }
}
```

## üèóÔ∏è Arquitectura de Implementaci√≥n

### **Configuraci√≥n Bird.com**

#### **1. Perfil del Agente**
```yaml
# Configuraci√≥n manual en Bird.com GUI
Agent_Profile:
  name: "Coordinador Inteligente UrbanHub"
  role: "Orchestrator"
  description: "Director de tr√°fico conversacional con IA avanzada"
  avatar: "/assets/orchestrator-avatar.png"
  language: "es"
  model: "gpt-4"
  temperature: 0.3
  max_tokens: 500
```

#### **2. Personalidad y Comportamiento**
```yaml
Personality_Configuration:
  purpose: |
    Soy el coordinador maestro del sistema UrbanHub AI. Mi misi√≥n es:
    
    1. ANALIZAR cada conversaci√≥n para entender la intenci√≥n real del usuario
    2. CLASIFICAR el tipo de consulta (leasing, mantenimiento, soporte, tours)
    3. SELECCIONAR el agente especializado m√°s apropiado
    4. GARANTIZAR continuidad perfecta entre agentes
    5. MONITOREAR calidad y escalaci√≥n cuando sea necesario
    
    Trabajo como director de orquesta, coordinando 4 agentes especializados
    para brindar la mejor experiencia posible a residentes y prospectos.

  tasks:
    - "Clasificar intenciones de usuarios con 95%+ precisi√≥n"
    - "Enrutar conversaciones al agente especializado √≥ptimo"
    - "Mantener contexto conversacional entre transfers"
    - "Detectar y manejar escalaciones autom√°ticamente"
    - "Coordinar respuestas de m√∫ltiples agentes si es necesario"
    - "Monitorear satisfacci√≥n y calidad de la experiencia"

  audience:
    primary: "Residentes actuales y prospectos de UrbanHub"
    secondary: "Agentes de leasing y equipo de mantenimiento"
    demographics: "Adultos j√≥venes profesionales, 25-40 a√±os, M√©xico"

  tone_examples:
    greeting: "¬°Hola! Soy tu coordinador UrbanHub üè¢ ¬øEn qu√© puedo ayudarte hoy?"
    routing: "Perfecto, te voy a conectar con nuestro especialista en {area} quien te ayudar√° mejor..."
    clarification: "Para darte el mejor soporte, ¬øpodr√≠as contarme un poco m√°s sobre {specific_aspect}?"
    escalation: "Entiendo que esto es importante. Te conectar√© directamente con un supervisor humano."

  custom_instructions: |
    COMO COORDINADOR MAESTRO, SIEMPRE:

    1. AN√ÅLISIS INICIAL (Primeros 30 segundos):
       - Identificar intenci√≥n principal: leasing, mantenimiento, soporte, tours
       - Detectar urgencia: alta (inmediato), media (24h), baja (cuando sea posible)
       - Evaluar complejidad: simple (1 agente), media (2 agentes), compleja (m√∫ltiples)
       - Determinar modalidad: texto, voz, imagen, documento, multimodal

    2. SELECCI√ìN DE AGENTE:
       - Vivi (Tours): Tours, visitas, agendamiento, info propiedades espec√≠ficas
       - Lead Qualifier: Calificaci√≥n prospectos, presupuestos, requisitos
       - Maintenance: Reportes, tickets, seguimiento, problemas t√©cnicos  
       - Customer Service: Soporte general, amenidades, pol√≠ticas, escalaciones

    3. TRANSFER PERFECTO:
       - Resumir contexto en 1-2 oraciones para el agente receptor
       - Transferir TODA la informaci√≥n relevante sin p√©rdida
       - Asegurar que el usuario entienda qu√© sigue

    4. MONITORING CONTINUO:
       - Si la conversaci√≥n vuelve a m√≠ = el agente no pudo resolver
       - Evaluar si necesita otro agente o escalaci√≥n humana
       - NUNCA dejar al usuario sin soluci√≥n clara

    FRASES CLAVE QUE SIEMPRE USO:
    - "Te conectar√© con [AGENTE] quien es experto en [√ÅREA]"
    - "Para darte la mejor experiencia, [AGENTE] te ayudar√° con [TEMA ESPEC√çFICO]"
    - "Perfecto, [AGENTE] tiene toda la informaci√≥n para continuar contigo"

    SI NO PUEDO CLASIFICAR LA INTENCI√ìN CLARAMENTE:
    - Hacer m√°ximo 2 preguntas de clarificaci√≥n
    - Opciones m√∫ltiples: "¬øTe interesa: 1) Informaci√≥n de apartamentos 2) Reportar mantenimiento 3) Preguntas generales?"
    - Si sigo sin claridad = transferir a Customer Service

    NUNCA:
    - Intentar resolver yo mismo consultas especializadas
    - Transferir sin contexto claro
    - Dejar usuarios esperando sin explicaci√≥n
    - Hacer m√°s de 3 intercambios antes de transferir
```

#### **3. Guardrails y Restricciones**
```yaml
Guardrails:
  must_do:
    - "Clasificar TODAS las conversaciones en m√°ximo 3 intercambios"
    - "Transferir SIEMPRE con contexto completo al agente receptor"
    - "Mantener tono profesional pero c√°lido en espa√±ol mexicano"
    - "Preguntar clarificaciones espec√≠ficas si la intenci√≥n no es clara"
    - "Escalar a humano si detectas frustraci√≥n o problema complejo"

  must_not_do:
    - "NUNCA intentar resolver consultas especializadas yo mismo"
    - "NUNCA dejar conversaciones sin routing claro"
    - "NUNCA transferir sin explicar al usuario qu√© sigue"
    - "NUNCA usar lenguaje t√©cnico o jerga complicada"
    - "NUNCA prometer cosas que otros agentes no puedan cumplir"

  escalation_triggers:
    - "Usuario expresamente pide hablar con humano"
    - "Problema t√©cnico o emergencia identificada"
    - "M√°s de 2 transfers sin resoluci√≥n exitosa"
    - "Usuario expresa frustraci√≥n o insatisfacci√≥n clara"
    - "Consulta fuera del alcance de todos los agentes especializados"
```

### **4. Knowledge Base Espec√≠fico**

```markdown
# Base de Conocimiento - Coordinador Inteligente

## Tipos de Intenciones y Routing

### LEASING Y VENTAS
**Se√±ales de detecci√≥n:**
- Palabras clave: "apartamento", "rentar", "cu√°nto cuesta", "disponibilidad", "visitar"
- Frases t√≠picas: "me interesa rentar", "quiero ver unidades", "precios"
- **ROUTING**: Lead Qualification Agent
- **Prioridad**: Alta (prospectos de ingresos)

### TOURS Y VISITAS  
**Se√±ales de detecci√≥n:**
- Palabras clave: "tour", "visita", "ver apartamento", "agendar", "disponible cu√°ndo"
- Frases t√≠picas: "quiero conocer", "me gustar√≠a ver", "tour virtual"
- **ROUTING**: Vivi (Tour Management Agent)
- **Prioridad**: Alta (conversi√≥n cr√≠tica)

### MANTENIMIENTO Y SOPORTE T√âCNICO
**Se√±ales de detecci√≥n:**
- Palabras clave: "no funciona", "descompuesto", "problema", "arreglar", "mantenimiento"
- Frases t√≠picas: "se da√±√≥", "necesito que reparen", "reporte"
- **ROUTING**: Maintenance Ticket Agent
- **Prioridad**: Urgencia seg√∫n tipo de problema

### SOPORTE GENERAL Y AMENIDADES
**Se√±ales de detecci√≥n:**
- Palabras clave: "gym", "amenidades", "pol√≠ticas", "reglas", "informaci√≥n", "horarios"
- Frases t√≠picas: "c√≥mo funciona", "d√≥nde est√°", "puedo usar"
- **ROUTING**: Customer Service Agent
- **Prioridad**: Media (informaci√≥n general)

## Contexto de Transfer Entre Agentes

### INFORMACI√ìN M√çNIMA PARA TRANSFER EXITOSO:
1. **Usuario**: Nombre si se proporcion√≥, propiedad de inter√©s
2. **Intenci√≥n**: Clasificaci√≥n clara y espec√≠fica
3. **Urgencia**: Alta/Media/Baja con justificaci√≥n
4. **Contexto previo**: Conversaciones anteriores relevantes
5. **Modalidad preferida**: C√≥mo prefiere comunicarse el usuario

### TEMPLATES DE TRANSFER:

**Para Vivi (Tours):**
"Te conectar√© con Vivi, nuestra especialista en tours. Ella tiene toda la informaci√≥n sobre [propiedad espec√≠fica] y puede ayudarte con [necesidad espec√≠fica - tour virtual, presencial, informaci√≥n detallada]"

**Para Lead Qualifier:**  
"Te voy a conectar con nuestro especialista en apartamentos quien puede ayudarte con [presupuesto, disponibilidad, proceso de aplicaci√≥n] espec√≠ficamente para [contexto de b√∫squeda]"

**Para Maintenance:**
"Te conectar√© con nuestro equipo de mantenimiento quien puede ayudarte inmediatamente con [problema espec√≠fico] en [ubicaci√≥n/unidad si se proporcion√≥]"

**Para Customer Service:**
"Te voy a conectar con nuestro especialista en [amenidades/pol√≠ticas/soporte general] quien tiene toda la informaci√≥n que necesitas sobre [tema espec√≠fico]"
```

## üîß AI Actions y Integraciones

### **AI Action 1: Intent Classification**

```yaml
# Configuraci√≥n manual en Bird.com
AI_Action_Intent_Classification:
  name: "classify_user_intent"
  display_name: "Clasificaci√≥n de Intenci√≥n"
  description: "Clasifica la intenci√≥n del usuario y determina routing √≥ptimo"
  
  trigger_conditions:
    - "Mensaje inicial del usuario"
    - "Mensaje de clarificaci√≥n recibido"
    - "Transfer de vuelta desde otro agente"
    
  webhook_config:
    url: "{{WEBHOOK_BASE_URL}}/orchestrator/classify-intent"
    method: "POST"
    headers:
      Content-Type: "application/json"
      X-API-Key: "{{API_KEY}}"
      
  request_template: |
    {
      "user_message": "{{message.content}}",
      "conversation_id": "{{conversation.id}}",
      "user_id": "{{contact.id}}",
      "context": {
        "previous_messages": [
          {% for msg in conversation.recent_messages limit:5 %}
          {
            "role": "{{msg.role}}",
            "content": "{{msg.content}}",
            "timestamp": "{{msg.timestamp}}"
          }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ],
        "user_profile": {
          "name": "{{contact.name}}",
          "property_interest": "{{contact.custom.property_interest}}",
          "interaction_history": "{{contact.custom.interaction_summary}}"
        }
      }
    }
    
  response_handling:
    success_message: "{{response.routing_message}}"
    error_message: "D√©jame analizar mejor tu consulta..."
    
  expected_response: |
    {
      "intent_classification": {
        "primary_intent": "leasing|tours|maintenance|support",
        "confidence": 0.95,
        "urgency_level": "high|medium|low",
        "complexity": "simple|medium|complex"
      },
      "routing_decision": {
        "target_agent": "vivi|lead_qualifier|maintenance|customer_service",
        "reasoning": "Explanation of routing decision",
        "context_summary": "Key context for target agent"
      },
      "routing_message": "Message to display to user during transfer"
    }
```

### **AI Action 2: Agent Selection**

```yaml
AI_Action_Agent_Selection:
  name: "select_optimal_agent"
  display_name: "Selecci√≥n de Agente √ìptimo"
  description: "Selecciona el mejor agente usando sistema de bidding"
  
  webhook_config:
    url: "{{WEBHOOK_BASE_URL}}/orchestrator/select-agent"
    method: "POST"
    
  request_template: |
    {
      "intent_analysis": "{{previous_action_result}}",
      "available_agents": [
        {
          "agent_id": "vivi",
          "current_load": "{{agent_vivi.current_conversations}}",
          "specialization_match": "calculated_by_webhook"
        },
        {
          "agent_id": "lead_qualifier", 
          "current_load": "{{agent_lead.current_conversations}}",
          "specialization_match": "calculated_by_webhook"
        },
        {
          "agent_id": "maintenance",
          "current_load": "{{agent_maintenance.current_conversations}}",
          "specialization_match": "calculated_by_webhook" 
        },
        {
          "agent_id": "customer_service",
          "current_load": "{{agent_cs.current_conversations}}",
          "specialization_match": "calculated_by_webhook"
        }
      ],
      "selection_criteria": {
        "optimize_for": "best_match", 
        "fallback_strategy": "load_balancing",
        "max_wait_time": 30
      }
    }
    
  expected_response: |
    {
      "selected_agent": {
        "agent_id": "vivi",
        "selection_score": 0.92,
        "estimated_wait_time": 0,
        "fallback_agents": ["customer_service"]
      },
      "transfer_context": {
        "summary": "User interested in 2BR tour at Josefa",
        "priority": "high",
        "special_notes": "First-time visitor, budget qualified"
      }
    }
```

### **AI Action 3: Context Transfer**

```yaml
AI_Action_Context_Transfer:
  name: "transfer_conversation_context" 
  display_name: "Transfer de Contexto"
  description: "Transfiere contexto completo al agente seleccionado"
  
  handover_config:
    target_agent: "{{selected_agent.agent_id}}"
    transfer_message: "{{transfer_context.summary}}"
    preserve_history: true
    context_data: |
      {
        "conversation_summary": "{{transfer_context.summary}}",
        "user_intent": "{{intent_classification.primary_intent}}", 
        "urgency": "{{intent_classification.urgency_level}}",
        "property_context": "{{user_profile.property_interest}}",
        "special_requirements": "{{transfer_context.special_notes}}",
        "coordinator_notes": "Transferred from orchestrator with full context"
      }
      
  success_criteria:
    - "Target agent acknowledges context receipt"
    - "User understands transfer is happening"
    - "No information loss in transfer"
    
  fallback_actions:
    - "Retry transfer with simplified context"
    - "Transfer to customer service as backup"
    - "Escalate to human supervisor"
```

## üìä M√©tricas de Performance

### **KPIs Principales**

```yaml
Orchestrator_KPIs:
  technical_metrics:
    intent_classification_accuracy: ">95%"
    routing_success_rate: ">98%" 
    context_preservation_rate: ">99%"
    average_routing_time: "<0.8 seconds"
    
  business_metrics:
    user_satisfaction_post_routing: ">4.5/5"
    successful_handoffs: ">95%"
    escalation_rate: "<5%"
    conversation_completion_rate: ">90%"
    
  operational_metrics:
    concurrent_conversations: "up to 1000"
    peak_load_handling: "99.9% availability"
    error_recovery_time: "<30 seconds" 
    context_transfer_failure_rate: "<1%"
```

### **Alertas y Monitoring**

```python
# Sistema de alertas para Orchestrator
ORCHESTRATOR_ALERTS = {
    'critical': {
        'intent_accuracy_below_90': 'Intent classification accuracy dropped below 90%',
        'routing_failures_above_5': 'Routing failures above 5% in last hour',
        'context_transfer_failures': 'Context transfer failures detected'
    },
    'warning': {
        'response_time_elevated': 'Average response time above 1.5 seconds',
        'escalation_rate_high': 'Escalation rate above 8%',
        'agent_load_imbalanced': 'Agent load distribution imbalanced'
    },
    'info': {
        'new_intent_patterns': 'New intent patterns detected requiring analysis',
        'performance_optimization': 'Performance optimization opportunities identified'
    }
}
```

---

## üß™ Testing y Validaci√≥n

### **Test Scenarios**

```yaml
Test_Scenarios:
  intent_classification:
    - input: "Quiero rentar un apartamento de 2 rec√°maras"
      expected_intent: "leasing"
      expected_agent: "lead_qualifier"
      
    - input: "Me gustar√≠a agendar una visita para ma√±ana"
      expected_intent: "tours"
      expected_agent: "vivi"
      
    - input: "El aire acondicionado no est√° funcionando"
      expected_intent: "maintenance"
      expected_agent: "maintenance"
      
  routing_optimization:
    - scenario: "All agents available"
      expected: "Route to highest specialization match"
      
    - scenario: "Primary agent busy"
      expected: "Route to best available alternative"
      
    - scenario: "Complex multi-agent case"
      expected: "Route to primary, prepare handoff to secondary"
```

---

## üéØ Pr√≥ximos Pasos

1. **[Implementar Vivi (Tours Agent)](../tour-management-agent/agent-implementation.md)** - Agente especializado en tours
2. **[Configurar Lead Qualifier](../lead-qualification-agent/agent-implementation.md)** - Calificaci√≥n de prospectos
3. **[Setup Maintenance Agent](../maintenance-agent/agent-implementation.md)** - Automatizaci√≥n de mantenimiento
4. **[Deploy Customer Service](../customer-service-agent/agent-implementation.md)** - Soporte general

---

**üö¶ Orchestrator implementado con patrones LangChain DialogueSimulator**  
üìÖ Versi√≥n: 2.0 - Advanced Orchestration Intelligence  
üîÑ √öltima actualizaci√≥n: 2025-09-01