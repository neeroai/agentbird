flowchart TD
    subgraph Notes1["ğŸ“‹ UrbanHub Properties (8 Locations)"]
        direction TB
        note1["ğŸ¢ Josefa (Reforma) | Matilde (Roma) | Polanco | Condesa<br>
        ğŸ¢ NÃ¡poles | JuÃ¡rez | Del Valle | Doctores<br>
        ğŸ“ All properties: Pet-friendly, No guarantor, 24/7 security<br>
        ğŸ’° Range: $15,400 - $28,400 MXN/month + services<br>
        ğŸ”§ Integrated with ValueKeep CMMS for 100% automation"]
    end
    
    subgraph Notes2["ğŸ“ Essential Data Capture Requirements"]
        direction TB
        note2["ğŸ” Required Information:<br>
        1 - Building (8 UrbanHub locations)<br>
        2 - Unit number (APT-XXX format)<br>
        3 - Problem description + photos<br>
        4 - Urgency level (AI keyword detection)<br>
        5 - Access instructions (pets, schedule)<br>
        6 - Preferred time slots (avoid PM conflicts)"]
    end

    subgraph ValueKeep["ğŸ”§ ValueKeep CMMS Integration Architecture"]
        direction TB
        VK1["ğŸ” OAuth2 Authentication<br>Client Credentials Flow<br>Auto-refresh 5min before expiry"]
        VK2["ğŸ“Š Core API Endpoints<br>POST /maintenance.workorders<br>GET /womanagements<br>GET /preventivemaintenancesevents<br>PATCH /workorders/{id}"]
        VK3["ğŸ”” Bidirectional Webhooks<br>WorkOrderStateChanged<br>TechnicianAssigned<br>WorkOrderCompleted<br>PreventiveMaintenanceReminder"]
        VK4["ğŸ“‹ Synchronized Catalogs<br>Priorities: URGENTE|ALTO|NORMAL|BAJA<br>States: S01-S09 workflow<br>Activities: Category-specific codes<br>Assets: 8 properties mapping"]
        VK1 --> VK2 --> VK3 --> VK4
    end

    subgraph BirdAI["ğŸ¤– Bird.com Multi-Agent Architecture"]
        direction TB
        BA1["ğŸš¦ Orchestrator Agent (Maya)<br>Intent Detection & Smart Routing<br><20 seconds response time"]
        BA2["ğŸ”§ Maintenance Agent (Carlos)<br>ValueKeep Integration Specialist<br>582 lines configuration"]
        BA3["âš™ï¸ Actions Configuration<br>CreateMaintenanceTicket<br>AutoAssignTechnician<br>CheckTicketStatus<br>SendProgressUpdates"]
        BA4["ğŸ›¡ï¸ Guardrails System<br>10 Must Do behaviors<br>10 Must Not Do restrictions<br>8 Escalation triggers"]
        BA1 --> BA2 --> BA3 --> BA4
    end

    subgraph Integration["ğŸ”Œ Integration Components"]
        direction TB
        INT1["ğŸŒ API Client (api-client.js)<br>OAuth2 + Rate limiting (60/min)<br>Retry logic with exponential backoff"]
        INT2["ğŸ« Ticket Manager (ticket-manager.js)<br>Orchestration + Smart assignment<br>Calendar conflict resolution"]
        INT3["ğŸ”” Webhook Handler (webhook-handler.js)<br>HMAC-SHA256 validation<br>Real-time state updates"]
        INT4["ğŸ—ºï¸ State Mapper (state-mapper.js)<br>ValueKeep â†” Bird transformations<br>Priority + Category mapping"]
        INT5["ğŸš¨ Error Handler (error-handler.js)<br>Monitoring + Alerts + Fallbacks<br>Slack notifications"]
        INT1 --> INT2 --> INT3 --> INT4 --> INT5
    end

    A["ğŸš€ Start: Resident Reports Issue"] --> B["ğŸ“± WhatsApp Message to UrbanHub"]
    B --> BA1
    BA1 --> C{"ğŸ¯ Intent Classification<br>AI-powered in <20 seconds"}
    C -->|ğŸ”§ Maintenance Request| BA2
    C -->|ğŸ’¼ Leasing Query| CS1["Lead Qualification Agent"]
    C -->|ğŸ“… Tour Request| CS2["Tour Management Agent"]
    C -->|â“ General Query| CS3["Customer Service Agent"]
    
    BA2 --> D["ğŸ“‹ Comprehensive Data Collection"]
    D --> E["ğŸ¢ Building Identification<br>Validate against 8 properties"]
    E --> F["ğŸšª Unit Number Validation<br>Format: APT-XXX"]  
    F --> G["ğŸ“ Problem Description Analysis<br>AI categorization + keyword detection"]
    G --> H["ğŸ“¸ Media Attachments Processing<br>Photos/videos for technician"]
    H --> I["ğŸ• Schedule Preferences Capture<br>Resident availability windows"]
    I --> J["ğŸ• Access Instructions<br>Pets, security, special notes"]
    
    J --> K["ğŸ¤– AI Classification Engine"]
    K --> L["ğŸ“Š Category Assignment<br>PLOMERIA | ELECTRICIDAD | HVAC<br>CARPINTERIA | ELECTRODOMESTICOS<br>CERRAJERIA | PINTURA | LIMPIEZA"]
    L --> M["ğŸš¨ Priority Calculation Algorithm<br>Keywords analysis + Category mapping<br>Timeline requirements assessment"]
    
    M --> N{"âš¡ Urgency Decision Point"}
    N -->|ğŸš¨ URGENTE| O["ğŸš¨ Emergency Fast Track<br>Override preventive maintenance<br>Immediate technician assignment"]
    N -->|ğŸ“… NORMAL/ALTA/BAJA| P["ğŸ“… Preventive Maintenance Validation<br>Check PM calendar conflicts"]
    
    P --> Q{"ğŸ” PM Conflict Detection<br>Query /preventivemaintenancesevents"}
    Q -->|âš ï¸ Conflict Found| R["ğŸ“… Smart Rescheduling<br>Propose alternative slots<br>Minimize resident impact"]
    Q -->|âœ… No Conflict| S["âœ… Time Slot Validated"]
    R --> S
    O --> S
    
    S --> INT2
    INT2 --> T["ğŸ”§ ValueKeep API Integration<br>POST /maintenance.workorders<br>OAuth2 authenticated request"]
    T --> U{"âœ… API Response Analysis"}
    U -->|201 Created| V["ğŸ« Work Order Created<br>Store: WO-YYYY-XXXXXX<br>Status: S01 (New)"]
    U -->|4xx/5xx Error| W["ğŸ”„ Intelligent Error Handling<br>Retry logic: 3 attempts<br>Exponential backoff strategy"]
    W -->|Max Retries Exceeded| X["ğŸš¨ Human Escalation<br>Operations team notification<br>Manual ticket creation fallback"]
    W -->|Retry Successful| V
    
    V --> Y["ğŸ‘¥ Intelligent Technician Assignment"]
    Y --> Z["ğŸ“Š Technician Availability Query<br>/maintenance.womanagements<br>Filter: location + specialty + date"]
    Z --> AA["ğŸ¯ Multi-Criteria Selection Algorithm<br>Score Calculation:<br>â€¢ Specialty match: +30 points<br>â€¢ Same building: +20 points<br>â€¢ Available in preferred time: +25 points<br>â€¢ Workload factor: -10 per active ticket"]
    AA --> BB["ğŸ† Optimal Technician Selected<br>Highest scored available tech"]
    BB --> CC["ğŸ“… Calendar Coordination<br>Schedule appointment in VK<br>Block technician time"]
    
    CC --> DD["âœ… Assignment Completed<br>PATCH /workorders/{id}<br>Update: assignedTechnician"]
    DD --> EE["ğŸ“¨ Resident Notification<br>Confirmation message with:<br>â€¢ Ticket number<br>â€¢ Technician name & contact<br>â€¢ Scheduled time<br>â€¢ Estimated duration"]
    EE --> FF["ğŸ”” ValueKeep State Transition<br>S01 (New) â†’ S09 (Assigned)<br>Webhook notification triggered"]
    
    FF --> GG["ğŸš› Technician Dispatch<br>Field work execution"]
    GG --> HH["ğŸ”” Real-time Progress Updates<br>S09 â†’ S02 (In Progress)<br>Webhook: 'TÃ©cnico en camino'"]
    HH --> II["âœ… Work Completion by Technician<br>S02 â†’ S03 (Completed)<br>Document resolution in VK"]
    
    II --> JJ["ğŸ”” Completion Webhook Processing<br>Auto-notification via Bird<br>'Trabajo completado, confirma por favor'"]
    JJ --> KK{"â“ Resident Satisfaction Check<br>Problem fully resolved?"}
    KK -->|âœ… Confirmed Resolved| LL["âœ… Ticket Final Closure<br>S03 â†’ S04 (Closed)<br>Archive in ValueKeep"]
    KK -->|âŒ Issue Persists| MM["ğŸ”„ Follow-up Protocol Activation"]
    
    MM --> NN["â¬†ï¸ Automatic Priority Escalation<br>Upgrade to URGENTE priority<br>Flag as recurring issue"]
    NN --> OO["ğŸ‘¥ Different Technician Assignment<br>Avoid same tech for quality<br>Select specialist or supervisor"]
    OO --> PP["ğŸ†• Follow-up Work Order Creation<br>Link to original: parent_ticket<br>Enhanced problem description"]
    PP --> CC
    
    LL --> QQ["ğŸ“Š Post-Resolution Activities<br>CSAT survey (1-5 scale)<br>Service quality feedback"]
    QQ --> RR["ğŸ“ˆ Analytics & Metrics Update<br>Performance tracking<br>SLA compliance monitoring<br>Technician performance"]
    RR --> SS["ğŸ¯ Complete Lifecycle End<br>Resident satisfied<br>Data archived<br>Metrics updated"]

    subgraph ErrorHandling["ğŸš¨ Error Handling & Recovery System"]
        direction TB
        EH1["ğŸ”„ Retry Logic Framework<br>Exponential backoff strategy<br>3 attempts with 1s, 2s, 4s delays"]
        EH2["ğŸ“Š Rate Limiting Compliance<br>60 requests/minute (production)<br>100 requests/minute (sandbox)<br>Queue management for peaks"]
        EH3["ğŸš¨ Monitoring & Alert System<br>Slack notifications (#maintenance-dev)<br>Email alerts (operations@urbanhub.mx)<br>SMS for critical failures"]
        EH4["ğŸ“‹ Fallback Mechanisms<br>Manual mode activation<br>Queue for retry<br>Cached responses<br>Human escalation"]
        EH5["ğŸ“ Comprehensive Logging<br>Winston logger integration<br>Error tracking & metrics<br>Audit trail maintenance"]
        EH1 --> EH2 --> EH3 --> EH4 --> EH5
    end

    subgraph StateFlow["ğŸ“Š ValueKeep State Management System"]
        direction LR
        S01["S01: New<br>ğŸ†• Created in system<br>SLA timer starts"]
        S09["S09: Assigned<br>ğŸ‘¨â€ğŸ”§ Technician allocated<br>Calendar appointment set"]
        S02["S02: In Progress<br>ğŸ”§ Active work session<br>Real-time updates"]
        S08["S08: QA Review<br>ğŸ” Quality assurance<br>Supervisor validation"]
        S03["S03: Completed<br>âœ… Work finished<br>Awaiting confirmation"]
        S04["S04: Closed<br>ğŸ Final closure<br>Archived status"]
        S05["S05: Canceled<br>âŒ Terminated<br>Reopen option available"]
        
        S01 --> S09
        S09 --> S02
        S02 --> S03
        S02 --> S08
        S08 --> S03
        S08 --> S02
        S03 --> S04
        S01 --> S05
        S02 --> S05
        S03 --> S05
        S04 --> S01
        S05 --> S01
    end

    subgraph TechAssignment["ğŸ‘¥ Intelligent Technician Assignment System"]
        direction TB
        TA1["ğŸ” Availability Query<br>GET /maintenance.womanagements<br>Parameters: date, location, specialty"]
        TA2["ğŸ“Š Multi-Criteria Scoring Algorithm<br>â€¢ Specialty match: +30 points<br>â€¢ Same building location: +20 points<br>â€¢ Available in preferred time: +25 points<br>â€¢ Lower workload: +10 per task difference<br>â€¢ Customer history bonus: +15 points"]
        TA3["ğŸ“… Calendar Validation<br>Check schedule conflicts<br>Validate appointment slots<br>Ensure PM event avoidance"]
        TA4["âœ… Optimal Assignment Execution<br>Update work order in ValueKeep<br>Create calendar appointment<br>Notify technician via app"]
        TA5["ğŸ”„ Assignment Backup Plan<br>If no tech available:<br>1. Escalate to operations manager<br>2. Queue for next available<br>3. Emergency contractor if urgent"]
        TA1 --> TA2 --> TA3 --> TA4 --> TA5
    end

    subgraph PMConflicts["ğŸ“… Preventive Maintenance Integration"]
        direction TB
        PM1["ğŸ” PM Event Query<br>GET /preventivemaintenancesevents<br>Check 7-day window ahead"]
        PM2["âš¡ Conflict Detection Logic<br>Compare requested time slots<br>Identify scheduling overlaps"]
        PM3["ğŸ“… Smart Rescheduling<br>Propose alternative times<br>Minimize resident inconvenience<br>Maintain SLA compliance"]
        PM4["ğŸš¨ Emergency Override<br>URGENTE tickets can bump PM<br>Automatic PM rescheduling<br>Stakeholder notifications"]
        PM1 --> PM2 --> PM3 --> PM4
    end

    %% Enhanced connections
    W --> ErrorHandling
    T --> StateFlow
    AA --> TechAssignment
    VK3 --> StateFlow
    P --> PMConflicts
    VK2 --> PMConflicts

    %% Enhanced styling
    note1:::notes
    note2:::notes
    A:::startEnd
    B:::process
    C:::decision
    D:::process
    E:::process
    F:::process
    G:::process
    H:::process
    I:::process
    J:::process
    K:::process
    L:::process
    M:::process
    N:::decision
    O:::urgent
    P:::process
    Q:::decision
    R:::process
    S:::process
    T:::api
    U:::decision
    V:::success
    W:::error
    X:::escalation
    Y:::process
    Z:::api
    AA:::algorithm
    BB:::success
    CC:::process
    DD:::success
    EE:::notification
    FF:::webhook
    GG:::process
    HH:::webhook
    II:::process
    JJ:::webhook
    KK:::decision
    LL:::success
    MM:::process
    NN:::escalation
    OO:::process
    PP:::api
    QQ:::process
    RR:::process
    SS:::startEnd
    CS1:::agent
    CS2:::agent
    CS3:::agent

    classDef startEnd fill:#90EE90,stroke:#2E8B57,stroke-width:3px
    classDef process fill:#ADD8E6,stroke:#4682B4,stroke-width:2px
    classDef decision fill:#FFB6C1,stroke:#DC143C,stroke-width:2px
    classDef api fill:#F0E68C,stroke:#DAA520,stroke-width:2px
    classDef urgent fill:#FF6B6B,stroke:#DC143C,stroke-width:3px
    classDef success fill:#98FB98,stroke:#228B22,stroke-width:2px
    classDef error fill:#FFA07A,stroke:#CD5C5C,stroke-width:2px
    classDef escalation fill:#DDA0DD,stroke:#9370DB,stroke-width:2px
    classDef notification fill:#87CEEB,stroke:#4169E1,stroke-width:2px
    classDef webhook fill:#F0E68C,stroke:#FF8C00,stroke-width:2px
    classDef algorithm fill:#DEB887,stroke:#A0522D,stroke-width:2px
    classDef agent fill:#E6E6FA,stroke:#8A2BE2,stroke-width:2px
    classDef notes fill:#FFFACD,stroke:#DDD,stroke-width:1px
